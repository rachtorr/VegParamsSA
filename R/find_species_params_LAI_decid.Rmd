---
title: "parameter filtering"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(reshape2)
library(RHESSysIOinR)
library(gridExtra)
library(zoo)
library(lubridate)
source("readin_selected_vars.R")
```

#### eucalyptus  

From 9450 runs 

Filtering the parameters sets to match:

1. The change in LAI from 2011-2014-2017 has to follow a similar pattern as the greenness in remote sensing data (Miller), where the change to 2014 is greater than the change to 2017, with 2011 as baseline
2. The pre-drought LAI / plantc / height have to be values within the range of the remote sensing data, at 95% confidence (Alonzo)  

output years are 2005 to 2025 (climate repeats after 8/2018)

This is test for eucalyptus. Note that am not using the BAAD carbon ratio fractions here.  

From sensitivity analysis (sobol.html), the top parameters that affect pre-drought summer LAI include:

- epc.psi_air_entry (soil def)
- epc.waring_pa
- epc.leaf_turnover
- epc.gl_smax
- epc.branch_turnover
- epc.min_percent_leafg

```{r data, message=FALSE, echo=F}
 
vars = c("height",
         "lai",
         "plantc",
         "rootdepth")
read <- readin_selected_vars(vars,  dir="../out/decid/allsim/")
read <- mkdate(read)

grouped <- read %>% group_by(year, run) %>%
  summarize_at(vars(all_of(vars)), funs(mean))

roll_mean <- arrange(grouped, run, year) %>%
  mutate(ma2=rollapply(lai, 5, mean, fill=NA)) %>%
  mutate(pc2=rollapply(plantc, 5, mean,fill=NA))

read_chng <- read %>% 
  dplyr::filter(year == 2011 | year== 2014 | year == 2017)  %>% 
  dplyr::filter(month==6 | month==7) %>% 
  dcast(run ~ year, value.var='lai',mean) %>% 
  mutate(change1 = (`2011`-`2014`)/`2011`) %>% 
  mutate(change2 = (`2011`-`2017`)/`2011`)

ggplot(read_chng) + geom_density(aes(x=`2011`, col='11 lai')) +
  geom_density(aes(x=`2014`, col='14 lai')) + 
  geom_density(aes(x=`2017`, col='17 lai'))

filt <-read_chng %>% dplyr::filter(change1 > change2)

params <- read.csv("../out/decid/allsim/decid.drtphen_all_options.csv")
# select only parameters
p <- params[,14:54]

p_names <- c(
      "pore_size_index",
      "psi_air",
      "run",
       "epc.leaf_cn",
       "epc.branch_turnover",
       "epc.gl_smax",
       "epc.flnr_age_mult",
       "epc.litter_moist_coef",
       "epc.psi_close",
       "mrc.q10",
       "epc.vpd_close",
       "epc.leaf_turnover",
       "epc.froot_turnover",
       "epc.storage_transfer_prop",
       "epc.height_to_stem_coef",
       "epc.waring_pa",
       "epc.root_growth_direction",
        "epc.root_distrib_parm",
       "epc.proj_sla",
       "epc.alloc_stemc_leafc",
       "epc.ext_coef",
       "specific_rain_capacity",
       "epc.flnr_sunlit",
       "epc.flnr_shade",
       "epc.netpabs_sunlit",
       "epc.netpabs_shade",
       "epc.netpabs_age_mult",
      "epc.cpool_mort_fract",
       "epc.min_percent_leafg",
      "epc.livewood_turnover",
      "epc.waring_pb",
      "epc.max_storage_percent",
      "epc.min_leaf_carbon",
      "epc.resprout_leaf_carbon",
      "epc.alloc_frootc_leafc",
      "epc.frootc_crootc",
      "epc.alloc_prop_day_growth",
            "epc.day_leafon",
      "epc.day_leafoff",
      "epc.ndays_expand",
      "epc.ndays_litfall")
colnames(p) <- c(p_names)


rs_dat <- read.csv("../R/data/rs_data_df.csv")
rs_dat <- dplyr::filter(rs_dat, fractionalcover > 0.7)
data <- read.csv("data/weighted_tree_summary.csv")
quag <- data[data$class == 34,]
low_lai <- quag$mean_wt_lai - 2*quag$sd_wt_lai
high_lai <- quag$mean_wt_lai + 2*quag$sd_wt_lai
low_carb <- quag$mean_wt_carb - 2*quag$sd_wt_carb
high_carb <- quag$mean_wt_carb + 2*quag$sd_wt_carb


read_ann <- roll_mean %>% dplyr::filter(year == 2011) %>%
  dplyr::filter(ma2 > low_lai & ma2 < high_lai &
                  lai > low_lai & lai < high_lai) %>%
dplyr::filter(pc2 > low_carb & pc2 < high_carb)  %>% 
dplyr::filter(plantc > low_carb & plantc < high_carb)

evergreen <- inner_join(filt, p, by="run")

# params_print <- params[params$...defs.shallow_NT.def.group_id %in% read_ann$run,]

```

We'll first look at the spread of the model output. 

The first pass of filtering results in `r nrow(filt)` parameter sets. 

```{r pft, warning=FALSE, message=FALSE, echo=FALSE}

quag_params2 <- read_ann[read_ann$run %in% filt$run,]

ggplot(grouped) + geom_density(aes(x=lai)) + 
  ggtitle("LAI across runs")
ggplot(grouped) + geom_density(aes(x=plantc)) + 
  ggtitle("plantc across runs")
ggplot(grouped) + geom_density(aes(x=height)) + 
  ggtitle("height across runs")

ggplot(grouped) + geom_jitter(aes(x=plantc, y=lai, col=height)) 

ggplot(filt) + geom_density(aes(x=`2011`, col='11')) + 
  geom_density(aes(x=`2014`, col='14')) + 
  geom_density(aes(x=`2017`, col='17')) + 
  ggtitle("filtered by delta2014 > delta2017")

```

See how there's two humps in the density plt? the idea is to get the second hump, that actually contains reasonable values of LAI. We can try that by filtering out the starting values in 2011 with plantc and LAI remote sensing estimates. 

```{r quag_filter, warning=F, echo=F}

quag_full <- rs_dat %>% dplyr::filter(class==34) 

 ggplot(quag_params2) + 
  geom_density(aes(x=height, col='model')) + 
  geom_density(data=quag_full, aes(x=height, col='data')) + 
  ggtitle(paste("height (eucalyptus n=", nrow(quag_params2),")", sep=""))

ggplot(quag_params2) + 
  geom_density(aes(x=lai, col='model')) + 
  geom_density(data=quag_full, aes(x=lai, col='data')) + 
  ggtitle(paste("LAI (eucalyptus n=", nrow(quag_params2),")", sep=""))

ggplot(quag_params2) + 
  geom_density(aes(x=plantc, col='model')) + 
  geom_density(data=quag_full, aes(x=carbperarea, col='data')) + 
  ggtitle(paste("carbon (eucalyptus n=", nrow(quag_params2),")", sep=""))

```

The second pass of filtering results in `r nrow(quag_params2)` parameter sets.

let's explore parameter values. 

```{r params, echo=F}

lai2 <- evergreen[evergreen$run %in% read_ann$run,]
filt2 <- evergreen[evergreen$run %in% filt$run,]

ggplot() + 
  geom_density(data=lai2, aes(x=epc.proj_sla, col='filtered by value')) +
  geom_density(data=filt2, aes(x=epc.proj_sla, col='filtered by % diff'))

ggplot() +   geom_density(data=lai2, aes(x=epc.leaf_turnover, col='filtered by value')) +
  geom_density(data=filt2, aes(x=epc.leaf_turnover, col='filtered by % diff'))
  ggtitle("leaf_turnover")

ggplot() +   geom_density(data=lai2, aes(x=epc.gl_smax, col='filtered by value')) +
  geom_density(data=filt2, aes(x=epc.gl_smax, col='filtered by % diff')) + 
  ggtitle("gl smax")

ggplot() +   geom_density(data=lai2, aes(x=epc.branch_turnover, col='filtered by value')) +
  geom_density(data=filt2, aes(x=epc.branch_turnover, col='filtered by % diff')) + 
  ggtitle("root growth direction")

ggplot() +   geom_density(data=lai2, aes(x=epc.waring_pa, col='filtered by value')) +
  geom_density(data=filt2, aes(x=epc.waring_pa, col='filtered by % diff')) + 
  ggtitle("waring pa")

read_chng2 <- read_chng[read_chng$run %in% quag_params2$run,]

ggplot(read_chng2) + geom_density(aes(x=`2011`, col='11')) +
  geom_density(aes(x=`2014`, col='14')) + 
  geom_density(aes(x=`2017`, col='17')) + ggtitle("LAI ann")

diff_plot <- read_chng2 %>% dplyr::select(-change1, -change2) %>% melt(id.vars='run') %>% ggplot() + geom_line(aes(x=as.factor(variable), y=value, col=as.factor(run), group=as.factor(run)), show.legend=F)
diff_plot + ggtitle("LAI ann differences")


pc <- read[read$run %in% quag_params2$run,]
pc %>% group_by(year, run) %>% 
  summarize_at(vars(plantc), list(mean)) %>% 
  dplyr::filter(year > 2010 & year < 2018) %>% 
  ggplot() + 
  geom_line(aes(x=year, y=plantc, col=as.factor(run)), show.legend=FALSE) + 
  ggtitle("plant c all filtered runs")

time_plot <- pc %>% group_by(year, run) %>% 
  summarize_at(vars(lai), list(mean)) %>% 
  dplyr::filter(year > 2010 & year < 2020) %>% 
  ggplot(aes(x=year, y=lai)) + 
  geom_jitter(show.legend=F, alpha=0.25) + 
  ggtitle("time series LAI all filtered runs")

pc_mn <- pc %>%  group_by(year) %>% 
  summarize_at(vars(lai), list(median)) %>% 
  dplyr::filter(year>2010 & year<2020)

pc_quant <- pc %>% group_by(year) %>% 
  dplyr::summarize(
    lai_first = quantile(lai, probs = c(0.25)), 
    lai_third = quantile(lai, probs = c(0.75))) %>% 
  dplyr::filter(year > 2010 & year < 2020)

time_plot + geom_line(data=pc_mn, aes(x=year, y=lai), col='green') +
  geom_line(data=pc_quant, aes(x=year, y=lai_first), col='red') +
  geom_line(data=pc_quant, aes(x=year, y=lai_third), col='red')

```


# write to def file 

3. Create new .def file for each species able to find
```{r defs, echo=FALSE, eval=FALSE}

quag <- params %>% 
  dplyr::filter(params$...defs.veg_liveoak.def.group_id %in% quag_params2$run)
nrow(quag)
quag$phen = "DECID"
quag$species = "eugl"

sc <- params %>% 
  dplyr::filter(params$...defs.veg_liveoak.def.group_id %in% pp_params$run)
nrow(sc)
sc$phen = "EVERGREEN"
sc$species = "scte_scmo"

piun <- params %>% 
  dplyr::filter(params$...defs.veg_liveoak.def.group_id %in% piun_params$run)
nrow(piun)
piun$phen = "EVERGREEN"
piun$species = "piun"

output = rbind(quag, sc, piun)

# write.csv(output, "../out/RHESSysIOinR_output/allsim_evergreen/all_options_broadleaf_evergreen.csv")

write.csv(quag, "../out/RHESSysIOinR_output/allsim/filtered_quag_269.csv")

```


4. Test new .def file with spinup and run over drought years 2010-2018 
5. Compare LAI / leafC with David's index data over drought period 2011-2014-2017
