---
title: "Evergreen species parameter selection"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(reshape2)
source("readin_selected_vars.R")

```


```{r data, message=FALSE, echo=F}
 
vars = c("dead_crootc",
         "dead_leafc",
         "dead_stemc",
         "leafc",
         "leafc_store",
         "live_crootc",
         "live_stemc",
         "height",
         "lai",
         "plantc",
         "rootdepth")
read <- readin_selected_vars(vars,  dir="../out/RHESSysIOinR_output/allsim/", start_date="2002-09-30", end_date = "2012-09-30" )

split_date <- str_split(read$date, pattern="-")
#  
# read_ann <- read %>%
#   mutate(year = as.numeric(lapply(split_date, "[[",1))) %>%
#   dplyr::group_by(year, run) %>%
#   #dplyr::filter(year>2009) %>% 
#   dplyr::summarize_all(list(mean)) geom_jitter(aes(x=year, y=lai)) +
#   geom_hline(yintercept=mean(read_ann$lai), col='red') +
#   ggtitle("avg annual LAI, red is avg across all runs and years")

read_ann <- read %>%
  mutate(year = as.numeric(lapply(split_date, "[[",1))) %>%
  dplyr::filter(year > 2009) %>% 
  dplyr::group_by(run) %>%
  dplyr::summarize_all(mean)


params <- read.csv("../out/RHESSysIOinR_output/evergreen.sob_all_options.csv")
# select only parameters
p <- params[,14:42]

p_names <- c(
      "pore_size_index",
      "psi_air",
      "run",
       "epc.leaf_cn",
       "epc.branch_turnover",
       "epc.gl_smax",
       "epc.flnr_age_mult",
       "epc.litter_moist_coef",
       "epc.psi_close",
       "mrc.q10",
       "epc.vpd_close",
       "epc.leaf_turnover",
       "epc.froot_turnover",
       "epc.storage_transfer_prop",
       "epc.height_to_stem_coef",
       "epc.waring_pa",
       "epc.root_growth_direction",
        "epc.root_distrib_parm",
       "epc.proj_sla",
       "epc.alloc_stemc_leafc",
       "epc.ext_coef",
       "specific_rain_capacity",
       "epc.flnr_sunlit",
       "epc.flnr_shade",
       "epc.netpabs_sunlit",
       "epc.netpabs_shade",
       "epc.netpabs_age_mult",
      "epc.cpool_mort_fract",
       "epc.min_percent_leafg")

colnames(p) <- c(p_names)
evergreen <- inner_join(read_ann, p, by="run")

rs_dat <- read.csv("../../plant_params/alonzo_data_df.csv")
rs_dat <- dplyr::filter(rs_dat, fractional_cov > 0.7)

rs_dat2 <- read.csv("data/weighted_tree_summary.csv")

```


```{r probs, echo=FALSE, message=FALSE}
p <- c(0.25, 0.5, 0.75)

p_n <- c('Q1','Q2','Q3')

p_funs <- map(p, ~partial(quantile, probs = .x, na.rm = TRUE)) %>% 
  set_names(nm = p_n)

```

## Compare with carbon mass fraction values

1. Filter with mass carbon fractions by PFT using BAAD data (gathered from several field and greenhouse studies / general), using different evergreen output.

the first round of filtering is done with root to shoot ratio (rsr) to get higher values of plant carbon 

```{r pft, warning=FALSE, message=FALSE, echo=FALSE}

baad <- read.csv("../../plant_params/baad_data/baad_data.csv")

# create ratios from individual baad values 
ratios <- baad %>%
  mutate(lmf = m.lf/m.to,
         smf = m.st/m.to,
         rmf = m.rt/m.to,
         rsr = m.rt/(m.st  + m.lf)) 

# set ranges of the ratios based on min and max
ranges <- ratios %>% 
  dplyr::select(lmf, smf, rmf, rsr, pft) %>%
  group_by(pft) %>% summarize_all(list(mn=min, mx=max), na.rm=T)
                        
# create carbon mass fractions from rhessys outputs
evergreen <- evergreen %>% mutate(totalc = leafc +
                       dead_leafc +
                       leafc_store +
                       dead_stemc +
                       live_stemc +
                       dead_crootc +
                       live_crootc)

evergreen <- evergreen %>% mutate(lmf = (leafc + dead_leafc + leafc_store)/totalc,
                     smf = (live_stemc + dead_stemc)/totalc,
                     rmf = (live_crootc + dead_crootc)/totalc,
                     rsr = (live_crootc + dead_crootc)/(dead_stemc + dead_leafc + leafc_store + live_stemc + leafc))

ggplot(evergreen) + geom_jitter(aes(x=rmf, y=rootdepth, col=epc.root_distrib_parm))

ggplot(evergreen) + geom_jitter(aes(x=rmf, y=rootdepth, col=epc.root_growth_direction))

# ####################################################
# # quickplot 
frac_mean <- evergreen %>% dplyr::select(lmf, smf, rmf, rsr) %>%
  melt() %>%
  dplyr::filter(value < 1) %>%
  mutate(dat = "rhessys")
baad_frac <- ratios %>% dplyr::select(lmf, smf, rmf, rsr) %>%
  melt() %>%
  dplyr::filter(value < 1) %>%
  mutate(dat = "baad")

toplot <- rbind(frac_mean, baad_frac)

compare <- ggplot(toplot) + geom_boxplot(aes(x=variable, y=value, fill=dat), position="dodge") +
ggtitle("compare rhessys evergreen output with all database values")
compare
####################################################
```

# Broadleaf Evergreens 

```{r broad, warning=FALSE, message=FALSE, echo=FALSE}

# set quartiles from baad ratios 
quartiles <- ratios %>% 
  dplyr::select(lmf, smf, rmf, rsr, pft) %>%
  group_by(pft) %>% summarize_all(funs(!!!p_funs))

# Broadleaf Evergreen 
# filter by each mass fraction and check 

# LMF 
EA1 <- evergreen %>% 
  dplyr::filter(lmf > quartiles$lmf_Q1[quartiles$pft=="EA"] &
                  lmf < quartiles$lmf_Q3[quartiles$pft=="EA"])
# 1578 sets

#RMF
EA2 <- evergreen %>% 
  dplyr::filter(rmf > quartiles$rmf_Q1[quartiles$pft=="EA"] &
                  rmf < quartiles$rmf_Q3[quartiles$pft=="EA"]) 
# 1736 sets 

#RSR
EA3 <- evergreen %>% 
  dplyr::filter(rsr > quartiles$rsr_Q1[quartiles$pft=="EA"] &
                  rsr < quartiles$rsr_Q3[quartiles$pft=="EA"]) 
# 1736 sets
# rmf and rsr are same

#SMF
EA4 <- evergreen %>% 
  dplyr::filter(smf < quartiles$smf_Q3[quartiles$pft=="EA"])
# 2686 sets

# select rhessys from root to shoot ratio 
rh_eg <- EA3 %>% dplyr::select(lai, height, carbon=plantc) %>%
  melt() 

ggplot() + geom_boxplot(data=rh_eg, aes(x=variable, y=value, col='rhessys')) + 
  geom_point(data=rs_dat2, aes(x="carbon", y=mean_wt_carb, col='data')) + 
    geom_point(data=rs_dat2, aes(x="lai", y=mean_wt_lai, col='data')) +
  geom_point(data=rs_dat2, aes(x="height", y=mean_wt_height, col='data'))
  ggtitle("comparing remote sensing wtd mean with filtered RH out")

ggplot(rh_eg) + 
  geom_density(aes(x=value, col=variable)) + 
  ggtitle("model output")  
  #geom_vline(data=rs_dat2, aes(xintercept=mean_wt_carb))

ggplot(evergreen) + geom_jitter(aes(x=plantc, y=lai, col=height))

```

## Quercus agrifolia  

filtering by lai and plantc
```{r quag_filter, warning=F, echo=F}

quag <- dplyr::filter(rs_dat2, class==81) 

filter <- ggplot(quag) +
  geom_jitter(data=evergreen, aes(x=plantc, y=lai)) + 
  geom_point(aes(x=mean_wt_carb, y=mean_wt_lai, col='mean')) + 
  geom_abline(aes(slope=0, intercept=low_lai, col='low')) + 
  geom_abline(aes(slope=0, intercept=high_lai, col='high')) +
  geom_vline(aes(xintercept=low_carb, col='low')) + 
  geom_vline(aes(xintercept=high_carb, col='high')) + ggtitle("QUAG")

quag_params2 <- evergreen %>% 
  dplyr::filter(plantc > quag$low_carb & plantc < quag$high_carb) %>% 
  dplyr::filter(lai > quag$low_lai & lai < quag$high_lai)  
  # dplyr::filter(height > quag$low_ht & height < quag$high_ht)

#filter + geom_jitter(data=quag_params2, aes(x=plantc, y=lai, col='sets'))

check_ht <- ggplot() + 
  geom_boxplot(data=quag_params2, aes(x='model', y=height)) + 
  geom_abline(data=quag, aes(slope=0, intercept=low_ht, col='lower bound')) + 
  geom_abline(data=quag, aes(slope=0, intercept=high_ht, col='upper bound')) + 
  ggtitle("check height output")

quag_full <- rs_dat %>% dplyr::filter(class==81) %>% 
  dplyr::filter(carbon < 20)

ggplot(quag_params2) + 
  geom_density(aes(x=height), col='red') + 
  geom_density(data=quag_full, aes(x=height), col='blue') + 
  ggtitle(paste("height (coast live oak n=", nrow(quag_params2),")", sep=""))

ggplot(quag_params2) + 
  geom_density(aes(x=lai, col='model')) + 
  geom_density(data=quag_full, aes(x=lai, col='data')) + 
  ggtitle(paste("LAI (coast live oak n=", nrow(quag_params2),")", sep=""))

ggplot(quag_params2) + 
  geom_density(aes(x=plantc, col='model')) + 
  geom_density(data=quag_full, aes(x=carbon, col='data')) + 
  ggtitle(paste("carbon (coast live oak n=", nrow(quag_params2),")", sep=""))

nrow(quag_params2)

### Plot with parameters
lai <- quag_params2

ggplot(lai) + geom_density(aes(x=pore_size_index)) + ggtitle("pore size index")

ggplot(lai) + geom_density(aes(x=epc.leaf_turnover)) + 
  ggtitle("leaf_turnover")

ggplot(lai) + geom_density(aes(x=epc.gl_smax)) + 
  ggtitle("gl smax")

ggplot(lai) + geom_density(aes(x=epc.root_distrib_parm)) + 
  ggtitle("root distrib")

ggplot(lai) + geom_density(aes(x=epc.waring_pa)) + 
  ggtitle("waring pa")
```


# write to def file 

3. Create new .def file for each species able to find
```{r defs, echo=FALSE, eval=FALSE}

quag <- params %>% 
  dplyr::filter(params$...defs.veg_liveoak.def.group_id %in% quag_params2$run)
nrow(quag)
quag$phen = "EVERGREEN"
quag$species = "quag"

sc <- params %>% 
  dplyr::filter(params$...defs.veg_liveoak.def.group_id %in% pp_params$run)
nrow(sc)
sc$phen = "EVERGREEN"
sc$species = "scte_scmo"

piun <- params %>% 
  dplyr::filter(params$...defs.veg_liveoak.def.group_id %in% piun_params$run)
nrow(piun)
piun$phen = "EVERGREEN"
piun$species = "piun"

output = rbind(quag, sc, piun)

# write.csv(output, "../out/RHESSysIOinR_output/allsim_evergreen/all_options_broadleaf_evergreen.csv")

write.csv(quag, "../out/RHESSysIOinR_output/allsim/filtered_quag.csv")

```



4. Test new .def file with spinup and run over drought years 2010-2018 
5. Compare LAI / leafC with David's index data over drought period 2011-2014-2017
